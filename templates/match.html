<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clothing Match Making</title>
    <style>
      .comparison-container { display: flex; gap: 20px; margin-top: 20px; }
      .item { border: 1px solid #ccc; padding: 10px; }
      .item img { max-width: 150px; margin-bottom: 10px; }
      .match-record { border: 1px solid #aaa; padding: 10px; margin: 10px 0; }
      .delete-btn { background: #f44336; color: #fff; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Clothing Match Making</h1>
    <!-- Match-making form -->
    <form id="matchForm" enctype="multipart/form-data">
        <input type="file" name="match_image" accept="image/*">
        <button type="submit">Find Best Match</button>
    </form>
    <div id="matchResult"></div>
    
    <!-- History: Display stored clothing items below the match form -->
    <h2>Stored Clothing Items</h2>
    <div id="history">
        {% for image in images %}
          <div id="img-{{ image.filename }}">
            <img src="{{ url_for('uploaded_file', filename=image.filename) }}" style="max-width:150px; margin:5px;">
            <div>Label: {{ image.label }}</div>
            <div>Wearable: {{ image.wearable }}</div>
            <div>Costume: {{ image.costume }}</div>
            <div>Sex: {{ image.sex }}</div>
            <div>
                Color: <span style="display:inline-block;width:20px;height:20px;background-color:{{ image.color }};border:1px solid #000;"></span>
                ({{ image.color }})
            </div>
            <div>Pattern: {{ image.pattern }}</div>
          </div>
        {% endfor %}
    </div>
    
    <!-- Perfect Matches Section -->
    <h2>Perfect Matches</h2>
    <button id="loadMatchesBtn">Load Perfect Matches</button>
    <button id="deleteAllMatchesBtn">Delete All Matches</button>
    <div id="matchesList"></div>
    
    <script>
      document.getElementById("matchForm").addEventListener("submit", async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const response = await fetch("/match_upload", {
              method: "POST",
              body: formData
          });
          const res = await response.json();
          const matchResultDiv = document.getElementById("matchResult");
          matchResultDiv.innerHTML = "";
          if(res.error){
             matchResultDiv.innerText = res.error;
             return;
          }
          const newItem = res.matched.new_item;
          const bestMatch = res.matched.best_match;
          
          const container = document.createElement('div');
          container.className = "comparison-container";
          
          const newDiv = document.createElement('div');
          newDiv.className = "item";
          newDiv.innerHTML = `
            <h3>New Item</h3>
            <img src="/uploads/${newItem.filename}" alt="New Item">
            <div>Label: ${newItem.label}</div>
            <div>Wearable: ${newItem.wearable}</div>
            <div>Costume: ${newItem.costume}</div>
            <div>Sex: ${newItem.sex}</div>
            <div>Color: ${newItem.color}</div>
            <div>Pattern: ${newItem.pattern}</div>
          `;
          
          const matchDiv = document.createElement('div');
          matchDiv.className = "item";
          if(bestMatch){
            matchDiv.innerHTML = `
              <h3>Best Match</h3>
              <img src="/uploads/${bestMatch.filename}" alt="Best Match">
              <div>Label: ${bestMatch.data.label}</div>
              <div>Wearable: ${bestMatch.data.wearable}</div>
              <div>Costume: ${bestMatch.data.costume}</div>
              <div>Sex: ${bestMatch.data.sex}</div>
              <div>Color: ${bestMatch.data.color}</div>
              <div>Pattern: ${bestMatch.data.pattern}</div>
              <div>Similarity Score: ${bestMatch.score.toFixed(2)}</div>
              <div>Reason: ${res.matched.reason}</div>
            `;
          } else {
            matchDiv.innerHTML = `<h3>No Matching Candidate Found</h3>`;
          }
          
          container.appendChild(newDiv);
          container.appendChild(matchDiv);
          matchResultDiv.appendChild(container);
      });
      
      document.getElementById("loadMatchesBtn").addEventListener("click", async function() {
          const response = await fetch("/matches", { method: "GET" });
          const res = await response.json();
          const matchesList = document.getElementById("matchesList");
          matchesList.innerHTML = "";
          if(res.matches.length === 0) {
              matchesList.innerText = "No perfect matches stored.";
              return;
          }
          res.matches.forEach((match, index) => {
              const record = document.createElement("div");
              record.className = "comparison-container";
              record.innerHTML = `
                  <div class="item">
                      <h4>New Item: ${match.new_item.label} (${match.new_item.wearable})</h4>
                      <img src="/uploads/${match.new_item.filename}" style="max-width:100px; margin-right:10px;">
                  </div>
                  <div class="item">
                      <h4>Best Match: ${match.best_match.data.label} (${match.best_match.data.wearable})</h4>
                      <img src="/uploads/${match.best_match.filename}" style="max-width:100px;">
                      <p>Similarity: ${match.best_match.score.toFixed(2)}</p>
                      <p>Reason: ${match.reason}</p>
                      <button class="delete-btn" data-index="${index}">Delete</button>
                  </div>
              `;
              matchesList.appendChild(record);
          });
          // Attach delete buttons events.
          Array.from(document.getElementsByClassName("delete-btn")).forEach(btn => {
              btn.addEventListener("click", async function() {
                  const index = this.getAttribute("data-index");
                  const formData = new FormData();
                  formData.append("index", index);
                  const delResponse = await fetch("/delete_match", { method: "POST", body: formData });
                  const delRes = await delResponse.json();
                  alert(delRes.message || delRes.error);
                  // Refresh matches list after deletion.
                  document.getElementById("loadMatchesBtn").click();
              });
          });
      });
      
      // Attach deletion event for deleting all matches.
      document.getElementById("deleteAllMatchesBtn").addEventListener("click", async function() {
          if(confirm("Are you sure you want to delete all matches?")) {
              const response = await fetch("/delete_all_matches", { method: "POST" });
              const res = await response.json();
              alert(res.message || res.error);
              document.getElementById("matchesList").innerHTML = "";
          }
      });
  </script>
</body>
</html>