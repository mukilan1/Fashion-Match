<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clothing Match Making</title>
    <style>
      .comparison-container { display: flex; gap: 20px; margin-top: 20px; }
      .item { border: 1px solid #ccc; padding: 10px; }
      .item img { max-width: 150px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Clothing Match Making</h1>
    <!-- Match-making form -->
    <form id="matchForm" enctype="multipart/form-data">
        <input type="file" name="match_image" accept="image/*">
        <button type="submit">Find Best Match</button>
    </form>
    <div id="matchResult"></div>
    
    <!-- History: Display stored clothing items below the match form -->
    <h2>Stored Clothing Items</h2>
    <div id="history">
        {% for image in images %}
          <div id="img-{{ image.filename }}">
            <img src="{{ url_for('uploaded_file', filename=image.filename) }}" style="max-width:150px; margin:5px;">
            <div>Label: {{ image.label }}</div>
            <div>Wearable: {{ image.wearable }}</div>
            <div>Costume: {{ image.costume }}</div>
            <div>Sex: {{ image.sex }}</div>
            <div>
                Color: <span style="display:inline-block;width:20px;height:20px;background-color:{{ image.color }};border:1px solid #000;"></span>
                ({{ image.color }})
            </div>
            <div>Pattern: {{ image.pattern }}</div>
            <div>Hand Style: {{ image.hand }}</div>
          </div>
        {% endfor %}
    </div>
    <script>
      document.getElementById("matchForm").addEventListener("submit", async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const response = await fetch("/match_upload", {
              method: "POST",
              body: formData
          });
          const res = await response.json();

          // Clear previous result
          const matchResultDiv = document.getElementById("matchResult");
          matchResultDiv.innerHTML = "";

          if(res.error){
             matchResultDiv.innerText = res.error;
             return;
          }

          const newItem = res.matched.new_item;
          const bestMatch = res.matched.best_match;
          
          // Create a comparison container.
          const container = document.createElement('div');
          container.className = "comparison-container";

          // New item details
          const newDiv = document.createElement('div');
          newDiv.className = "item";
          newDiv.innerHTML = `
            <h3>New Item</h3>
            <img src="/uploads/${newItem.filename}" alt="New Item">
            <div>Label: ${newItem.label}</div>
            <div>Wearable: ${newItem.wearable}</div>
            <div>Costume: ${newItem.costume}</div>
            <div>Sex: ${newItem.sex}</div>
            <div>Color: ${newItem.color}</div>
            <div>Pattern: ${newItem.pattern}</div>
            <div>Hand Style: ${newItem.hand}</div>
          `;

          // Best match details if candidate found.
          const matchDiv = document.createElement('div');
          matchDiv.className = "item";
          if(bestMatch){
            matchDiv.innerHTML = `
              <h3>Best Match</h3>
              <img src="/uploads/${bestMatch.filename}" alt="Best Match">
              <div>Label: ${bestMatch.data.label}</div>
              <div>Wearable: ${bestMatch.data.wearable}</div>
              <div>Costume: ${bestMatch.data.costume}</div>
              <div>Sex: ${bestMatch.data.sex}</div>
              <div>Color: ${bestMatch.data.color}</div>
              <div>Pattern: ${bestMatch.data.pattern}</div>
              <div>Hand Style: ${bestMatch.data.hand}</div>
              <div>Similarity Score: ${bestMatch.score.toFixed(2)}</div>
            `;
          } else {
            matchDiv.innerHTML = `<h3>No Matching Candidate Found</h3>`;
          }
          
          container.appendChild(newDiv);
          container.appendChild(matchDiv);
          matchResultDiv.appendChild(container);
      });
    </script>
</body>
</html>
