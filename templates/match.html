<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clothing Match Making</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
      body { 
        background-color: #f8f9fa; 
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding-bottom: 50px;
      }
      .header {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
        text-align: center;
      }
      .comparison-container { 
        display: flex; 
        gap: 20px; 
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .item { 
        border: 1px solid #e0e0e0; 
        padding: 20px; 
        border-radius: 10px;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,.05);
        flex: 1;
        min-width: 300px;
        transition: transform 0.2s;
      }
      .item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,.1);
      }
      .item img { 
        max-width: 100%; 
        height: auto; 
        margin-bottom: 15px;
        border-radius: 8px;
        object-fit: cover;
      }
      .match-record { 
        border: 1px solid #e0e0e0; 
        background-color: white;
        padding: 20px; 
        margin: 20px 0; 
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,.05);
      }
      .delete-btn { 
        background: #dc3545; 
        color: #fff; 
        border: none; 
        padding: 8px 16px; 
        cursor: pointer; 
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .delete-btn:hover {
        background: #c82333;
      }
      .reason-container { 
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 20px;
        margin-top: 20px;
        border-radius: 8px;
        font-style: italic;
        color: #555;
        box-shadow: 0 2px 4px rgba(0,0,0,.05);
      }
      .reason-container h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 12px;
        font-size: 1.25rem;
      }
      .section-heading {
        margin: 40px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
        color: #333;
      }
      .upload-form {
        background-color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,.05);
        margin-bottom: 30px;
      }
      .property-list {
        list-style: none;
        padding-left: 0;
      }
      .property-list li {
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }
      .property-name {
        font-weight: 500;
        color: #555;
      }
      .property-value {
        font-weight: 400;
        color: #212529;
      }
      .color-sample {
        display: inline-block;
        width: 25px;
        height: 25px;
        border-radius: 4px;
        vertical-align: middle;
        margin-right: 8px;
        border: 1px solid #ddd;
      }
      .btn-primary {
        background: linear-gradient(135deg, #4a90e2 0%, #2575fc 100%);
        border: none;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #3a80d2 0%, #1565ec 100%);
      }
      .item-header {
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .nav-button {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }
      /* Loading animation styles */
      .loading-container {
        display: none;
        text-align: center;
        padding: 30px;
        margin: 20px 0;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
      }
      
      .loading-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #2575fc, transparent);
        animation: loading-bar 2s linear infinite;
      }
      
      .loading-spinner {
        display: inline-block;
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
      }
      
      .loading-spinner:after {
        content: " ";
        display: block;
        width: 64px;
        height: 64px;
        margin: 8px;
        border-radius: 50%;
        border: 6px solid #2575fc;
        border-color: #2575fc transparent #2575fc transparent;
        animation: loading-spinner 1.2s linear infinite;
      }
      
      .loading-text {
        font-size: 1.2rem;
        color: #333;
        margin-bottom: 10px;
        font-weight: 500;
      }
      
      .loading-subtext {
        font-size: 0.9rem;
        color: #777;
        font-style: italic;
      }
      
      @keyframes loading-spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes loading-bar {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      
      .loading-clothing-icons {
        margin: 15px 0;
      }
      
      .loading-clothing-icons i {
        font-size: 24px;
        color: #6a11cb;
        margin: 0 10px;
        opacity: 0;
        animation: fade-in-out 3s infinite;
      }
      
      .loading-clothing-icons i:nth-child(2) {
        animation-delay: 0.5s;
      }
      
      .loading-clothing-icons i:nth-child(3) {
        animation-delay: 1s;
      }
      
      .loading-clothing-icons i:nth-child(4) {
        animation-delay: 1.5s;
      }
      
      @keyframes fade-in-out {
        0%, 100% { opacity: 0; transform: translateY(0); }
        50% { opacity: 1; transform: translateY(-10px); }
      }
      
      .showing {
        display: block;
        animation: fade-in 0.5s forwards;
      }
      
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
</head>
<body>
    <a href="/" class="btn btn-light nav-button"><i class="fas fa-arrow-left"></i> Back to Upload</a>
    
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-tshirt"></i> Clothing Match Maker</h1>
            <p class="lead">Find the perfect match for your clothing item</p>
        </div>
    </div>

    <div class="container">
        <!-- Match-making form -->
        <div class="upload-form">
            <form id="matchForm" enctype="multipart/form-data" class="row g-3 align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="file" name="match_image" accept="image/*" class="form-control" id="inputGroupFile">
                        <label for="inputGroupFile" class="input-group-text">Choose file</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Find Best Match
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Loading Animation -->
        <div id="loadingAnimation" class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Finding your perfect match...</div>
            <div class="loading-clothing-icons">
                <i class="fas fa-tshirt"></i>
                <i class="fas fa-socks"></i>
                <i class="fas fa-hat-cowboy"></i>
                <i class="fas fa-mitten"></i>
            </div>
            <div class="loading-subtext">Analyzing colors, patterns, and styles...</div>
        </div>
        
        <div id="matchResult" class="mb-5"></div>
        
        <!-- Perfect Matches Section -->
        <h2 class="section-heading"><i class="fas fa-star"></i> Perfect Matches</h2>
        <div class="d-flex gap-3 mb-4">
            <button id="loadMatchesBtn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Load Perfect Matches
            </button>
            <button id="deleteAllMatchesBtn" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Delete All Matches
            </button>
        </div>
        <div id="matchesList" class="mb-5"></div>
        
        <!-- History: Display stored clothing items -->
        <h2 class="section-heading"><i class="fas fa-archive"></i> Clothing Inventory</h2>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4" id="history">
            {% for image in images %}
              <div class="col" id="img-{{ image.filename }}">
                <div class="item h-100">
                    <img src="{{ url_for('uploaded_file', filename=image.filename) }}" class="img-fluid mb-3" alt="{{ image.label }}">
                    <ul class="property-list">
                        <li>
                            <span class="property-name">Label:</span> 
                            <span class="property-value">{{ image.label }}</span>
                        </li>
                        <li>
                            <span class="property-name">Wearable:</span> 
                            <span class="property-value">{{ image.wearable }}</span>
                        </li>
                        <li>
                            <span class="property-name">Costume:</span> 
                            <span class="property-value">{{ image.costume }}</span>
                        </li>
                        <li>
                            <span class="property-name">Sex:</span> 
                            <span class="property-value">{{ image.sex }}</span>
                        </li>
                        <li>
                            <span class="property-name">Color:</span> 
                            <span class="property-value">
                                <span class="color-sample" style="background-color:{{ image.color }};"></span>
                                {{ image.color }}
                            </span>
                        </li>
                        <li>
                            <span class="property-name">Pattern:</span> 
                            <span class="property-value">{{ image.pattern }}</span>
                        </li>
                    </ul>
                </div>
              </div>
            {% endfor %}
        </div>
    </div>
    
    <script>
      document.getElementById("matchForm").addEventListener("submit", async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          
          // Show loading animation
          const loadingAnimation = document.getElementById("loadingAnimation");
          const matchResultDiv = document.getElementById("matchResult");
          
          loadingAnimation.classList.add("showing");
          matchResultDiv.innerHTML = "";
          
          try {
              const response = await fetch("/match_upload", {
                  method: "POST",
                  body: formData
              });
              const res = await response.json();
              
              // Hide loading after a minimum time (for better UX)
              setTimeout(() => {
                  // Hide loading animation
                  loadingAnimation.classList.remove("showing");
                  
                  if(res.error){
                     matchResultDiv.innerText = res.error;
                     return;
                  }
                  const newItem = res.matched.new_item;
                  const bestMatch = res.matched.best_match;
                  
                  const container = document.createElement('div');
                  container.className = "comparison-container";
                  
                  const newDiv = document.createElement('div');
                  newDiv.className = "item";
                  newDiv.innerHTML = `
                    <h3 class="item-header">New Item</h3>
                    <img src="/uploads/${newItem.filename}" alt="New Item">
                    <ul class="property-list">
                      <li><span class="property-name">Label:</span> <span class="property-value">${newItem.label}</span></li>
                      <li><span class="property-name">Wearable:</span> <span class="property-value">${newItem.wearable}</span></li>
                      <li><span class="property-name">Costume:</span> <span class="property-value">${newItem.costume}</span></li>
                      <li><span class="property-name">Sex:</span> <span class="property-value">${newItem.sex}</span></li>
                      <li>
                        <span class="property-name">Color:</span> 
                        <span class="property-value">
                          <span class="color-sample" style="background-color:${newItem.color};"></span>
                          ${newItem.color}
                        </span>
                      </li>
                      <li><span class="property-name">Pattern:</span> <span class="property-value">${newItem.pattern}</span></li>
                    </ul>
                  `;
                  
                  const matchDiv = document.createElement('div');
                  matchDiv.className = "item";
                  if(bestMatch){
                    matchDiv.innerHTML = `
                      <h3 class="item-header">Best Match</h3>
                      <img src="/uploads/${bestMatch.filename}" alt="Best Match">
                      <ul class="property-list">
                        <li><span class="property-name">Label:</span> <span class="property-value">${bestMatch.data.label}</span></li>
                        <li><span class="property-name">Wearable:</span> <span class="property-value">${bestMatch.data.wearable}</span></li>
                        <li><span class="property-name">Costume:</span> <span class="property-value">${bestMatch.data.costume}</span></li>
                        <li><span class="property-name">Sex:</span> <span class="property-value">${bestMatch.data.sex}</span></li>
                        <li>
                          <span class="property-name">Color:</span> 
                          <span class="property-value">
                            <span class="color-sample" style="background-color:${bestMatch.data.color};"></span>
                            ${bestMatch.data.color}
                          </span>
                        </li>
                        <li><span class="property-name">Pattern:</span> <span class="property-value">${bestMatch.data.pattern}</span></li>
                        <li><span class="property-name">Similarity Score:</span> <span class="property-value">${bestMatch.score.toFixed(2)}</span></li>
                      </ul>
                    `;
                  } else {
                    matchDiv.innerHTML = `<h3 class="item-header">No Matching Candidate Found</h3>`;
                  }
                  
                  container.appendChild(newDiv);
                  container.appendChild(matchDiv);
                  matchResultDiv.appendChild(container);
                  
                  // Add reason in a separate container
                  if(bestMatch && res.matched.reason) {
                    const reasonContainer = document.createElement('div');
                    reasonContainer.className = "reason-container";
                    reasonContainer.innerHTML = `
                      <h3>Why These Match Well</h3>
                      <p>${res.matched.reason}</p>
                    `;
                    matchResultDiv.appendChild(reasonContainer);
                  }
              }, 800); // Minimum display time for loading animation
          } catch (error) {
              // Handle any errors
              loadingAnimation.classList.remove("showing");
              matchResultDiv.innerHTML = `<div class="alert alert-danger">An error occurred: ${error.message}</div>`;
          }
      });
      
      document.getElementById("loadMatchesBtn").addEventListener("click", async function() {
          const response = await fetch("/matches", { method: "GET" });
          const res = await response.json();
          const matchesList = document.getElementById("matchesList");
          matchesList.innerHTML = "";
          if(res.matches.length === 0) {
              matchesList.innerText = "No perfect matches stored.";
              return;
          }
          res.matches.forEach((match, index) => {
              const record = document.createElement("div");
              record.className = "comparison-container";
              record.innerHTML = `
                  <div class="item">
                      <h4>New Item: ${match.new_item.label} (${match.new_item.wearable})</h4>
                      <img src="/uploads/${match.new_item.filename}" style="max-width:100px; margin-right:10px;">
                  </div>
                  <div class="item">
                      <h4>Best Match: ${match.best_match.data.label} (${match.best_match.data.wearable})</h4>
                      <img src="/uploads/${match.best_match.filename}" style="max-width:100px;">
                      <p>Similarity: ${match.best_match.score.toFixed(2)}</p>
                      <button class="delete-btn" data-index="${index}">Delete</button>
                  </div>
              `;
              matchesList.appendChild(record);
              
              // Add reason in a separate container for each match record
              if(match.reason) {
                const reasonContainer = document.createElement('div');
                reasonContainer.className = "reason-container";
                reasonContainer.innerHTML = `
                  <h3>Why These Match Well</h3>
                  <p>${match.reason}</p>
                `;
                matchesList.appendChild(reasonContainer);
              }
          });
          // Attach delete buttons events.
          Array.from(document.getElementsByClassName("delete-btn")).forEach(btn => {
              btn.addEventListener("click", async function() {
                  const index = this.getAttribute("data-index");
                  const formData = new FormData();
                  formData.append("index", index);
                  const delResponse = await fetch("/delete_match", { method: "POST", body: formData });
                  const delRes = await delResponse.json();
                  alert(delRes.message || delRes.error);
                  // Refresh matches list after deletion.
                  document.getElementById("loadMatchesBtn").click();
              });
          });
      });
      
      // Attach deletion event for deleting all matches.
      document.getElementById("deleteAllMatchesBtn").addEventListener("click", async function() {
          if(confirm("Are you sure you want to delete all matches?")) {
              const response = await fetch("/delete_all_matches", { method: "POST" });
              const res = await response.json();
              alert(res.message || res.error);
              document.getElementById("matchesList").innerHTML = "";
          }
      });
  </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>