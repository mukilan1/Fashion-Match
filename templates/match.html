<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clothing Match Making</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
      body { 
        background-color: #f8f9fa; 
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding-bottom: 50px;
      }
      .header {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
        text-align: center;
      }
      .comparison-container { 
        display: flex; 
        gap: 20px; 
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .item { 
        border: 1px solid #e0e0e0; 
        padding: 20px; 
        border-radius: 10px;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,.05);
        flex: 1;
        min-width: 300px;
        transition: transform 0.2s;
      }
      .item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,.1);
      }
      .item img { 
        max-width: 100%; 
        height: auto; 
        margin-bottom: 15px;
        border-radius: 8px;
        object-fit: contain;
        transition: opacity 0.3s;
      }
      .image-wrapper {
        position: relative;
        min-height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden; /* Prevent content overflow */
      }
      .image-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        color: #6c757d;
      }
      .image-error {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        color: #dc3545;
        z-index: 5;
      }
      .retry-image-btn {
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        margin-top: 10px;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .retry-image-btn:hover {
        background-color: #5a6268;
      }
      .fade-in {
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .match-record { 
        border: 1px solid #e0e0e0; 
        background-color: white;
        padding: 20px; 
        margin: 20px 0; 
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,.05);
      }
      .delete-btn { 
        background: #dc3545; 
        color: #fff; 
        border: none; 
        padding: 8px 16px; 
        cursor: pointer; 
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .delete-btn:hover {
        background: #c82333;
      }
      .reason-container { 
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 20px;
        margin-top: 20px;
        border-radius: 8px;
        font-style: italic;
        color: #555;
        box-shadow: 0 2px 4px rgba(0,0,0,.05);
      }
      .reason-container h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 12px;
        font-size: 1.25rem;
      }
      .section-heading {
        margin: 40px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
        color: #333;
      }
      .upload-form {
        background-color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,.05);
        margin-bottom: 30px;
      }
      .property-list {
        list-style: none;
        padding-left: 0;
      }
      .property-list li {
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }
      .property-name {
        font-weight: 500;
        color: #555;
      }
      .property-value {
        font-weight: 400;
        color: #212529;
      }
      .color-sample {
        display: inline-block;
        width: 25px;
        height: 25px;
        border-radius: 4px;
        vertical-align: middle;
        margin-right: 8px;
        border: 1px solid #ddd;
      }
      .btn-primary {
        background: linear-gradient(135deg, #4a90e2 0%, #2575fc 100%);
        border: none;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #3a80d2 0%, #1565ec 100%);
      }
      .item-header {
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .nav-button {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }
      /* Loading animation styles */
      .loading-container {
        display: none;
        text-align: center;
        padding: 30px;
        margin: 20px 0;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
      }
      
      .loading-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #2575fc, transparent);
        animation: loading-bar 2s linear infinite;
      }
      
      .loading-spinner {
        display: inline-block;
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
      }
      
      .loading-spinner:after {
        content: " ";
        display: block;
        width: 64px;
        height: 64px;
        margin: 8px;
        border-radius: 50%;
        border: 6px solid #2575fc;
        border-color: #2575fc transparent #2575fc transparent;
        animation: loading-spinner 1.2s linear infinite;
      }
      
      .loading-text {
        font-size: 1.2rem;
        color: #333;
        margin-bottom: 10px;
        font-weight: 500;
      }
      
      .loading-subtext {
        font-size: 0.9rem;
        color: #777;
        font-style: italic;
      }
      
      @keyframes loading-spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes loading-bar {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      
      .loading-clothing-icons {
        margin: 15px 0;
      }
      
      .loading-clothing-icons i {
        font-size: 24px;
        color: #6a11cb;
        margin: 0 10px;
        opacity: 0;
        animation: fade-in-out 3s infinite;
      }
      
      .loading-clothing-icons i:nth-child(2) {
        animation-delay: 0.5s;
      }
      
      .loading-clothing-icons i:nth-child(3) {
        animation-delay: 1s;
      }
      
      .loading-clothing-icons i:nth-child(4) {
        animation-delay: 1.5s;
      }
      
      @keyframes fade-in-out {
        0%, 100% { opacity: 0; transform: translateY(0); }
        50% { opacity: 1; transform: translateY(-10px); }
      }
      
      .showing {
        display: block;
        animation: fade-in 0.5s forwards;
      }
      
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* Additional styles for fallback handling */
      .default-image {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        height: 100%;
        background-color: #f0f0f0;
        border-radius: 8px;
        color: #6c757d;
        min-height: 200px;
      }
      
      .fallback-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: #6c757d;
      }
      
      /* Enhanced error display */
      .connection-error {
        background-color: #f8d7da;
        color: #721c24;
      }
      
      .single-reason {
        font-size: 1.1rem;
        line-height: 1.5;
        color: #333;
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 5px;
        border-left: 4px solid #2575fc;
        margin: 10px 0;
      }
    </style>
</head>
<body>
    <a href="/" class="btn btn-light nav-button"><i class="fas fa-arrow-left"></i> Back to Upload</a>
    
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-tshirt"></i> Clothing Match Maker</h1>
            <p class="lead">Find the perfect match for your clothing item</p>
        </div>
    </div>

    <div class="container">
        <!-- Add global progress indicator for match page -->
        <div id="globalProgressContainer" class="progress mb-4" style="display:none;">
            <div id="globalProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div id="progressDetails" class="alert alert-info mb-4" style="display:none;">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <div id="progressText">Processing...</div>
            </div>
        </div>
        
        <!-- Match-making form -->
        <div class="upload-form">
            <form id="matchForm" enctype="multipart/form-data" class="row g-3 align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="file" name="match_image" accept="image/*" class="form-control" id="inputGroupFile">
                        <label for="inputGroupFile" class="input-group-text">Choose file</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Find Best Match
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Loading Animation -->
        <div id="loadingAnimation" class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Finding your perfect match...</div>
            <div class="loading-clothing-icons">
                <i class="fas fa-tshirt"></i>
                <i class="fas fa-socks"></i>
                <i class="fas fa-hat-cowboy"></i>
                <i class="fas fa-mitten"></i>
            </div>
            <div class="loading-subtext">Analyzing colors, patterns, and styles...</div>
        </div>
        
        <div id="matchResult" class="mb-5"></div>
        
        <!-- Perfect Matches Section -->
        <h2 class="section-heading"><i class="fas fa-star"></i> Perfect Matches</h2>
        <div class="d-flex gap-3 mb-4">
            <button id="loadMatchesBtn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Load Perfect Matches
            </button>
            <button id="deleteAllMatchesBtn" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Delete All Matches
            </button>
        </div>
        <div id="matchesList" class="mb-5"></div>
        
        <!-- History: Display stored clothing items -->
        <h2 class="section-heading"><i class="fas fa-archive"></i> Clothing Inventory</h2>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4" id="history">
            {% for image in images %}
              <div class="col" id="img-{{ image.filename }}">
                <div class="item h-100">
                    <div class="image-wrapper">
                        {% if image.is_valid %}
                            <div class="image-loading">
                                <div class="spinner-border text-primary mb-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Loading image...</span>
                            </div>
                            <img src="{{ url_for('uploaded_file', filename=image.filename) }}?t={{ range(1, 9999) | random }}" 
                                 class="img-fluid" 
                                 alt="{{ image.label }}"
                                 data-filename="{{ image.filename }}"
                                 data-valid="true"
                                 onload="this.previousElementSibling.style.display='none';"
                                 onerror="handleMatchImageError(this, '{{ image.filename }}')">
                        {% else %}
                            <!-- Display fallback for invalid images -->
                            <div class="default-image">
                                <i class="fas fa-tshirt fallback-icon"></i>
                                <p>{{ image.label }}</p>
                                <small>(Image unavailable)</small>
                            </div>
                        {% endif %}
                    </div>
                    <ul class="property-list">
                        <li>
                            <span class="property-name">Label:</span> 
                            <span class="property-value">{{ image.label }}</span>
                        </li>
                        <li>
                            <span class="property-name">Wearable:</span> 
                            <span class="property-value">{{ image.wearable }}</span>
                        </li>
                        <li>
                            <span class="property-name">Costume:</span> 
                            <span class="property-value">{{ image.costume }}</span>
                        </li>
                        <li>
                            <span class="property-name">Sex:</span> 
                            <span class="property-value">{{ image.sex }}</span>
                        </li>
                        <li>
                            <span class="property-name">Color:</span> 
                            <span class="property-value">
                                <span class="color-sample" style="background-color:{{ image.color }};"></span>
                                {{ image.color }}
                            </span>
                        </li>
                        <li>
                            <span class="property-name">Pattern:</span> 
                            <span class="property-value">{{ image.pattern }}</span>
                        </li>
                    </ul>
                </div>
              </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Navigation area - FIXED -->
    <div class="container mb-4">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="/" class="btn btn-secondary me-2">
                <i class="fas fa-home"></i> Back to Home
            </a>
            <a href="/pose_rigging" class="btn btn-success">
                <i class="fas fa-user-alt"></i> Pose Rigging
            </a>
        </div>
    </div>
    
    <script>
  // COMPLETELY REBUILT SCRIPT
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Match page initialized");
    
    // ==================== HELPER FUNCTIONS ====================
    function showProgress(percent, text) {
      const progressContainer = document.getElementById('globalProgressContainer');
      const progressBar = document.getElementById('globalProgressBar');
      const progressText = document.getElementById('progressText');
      
      if (!progressContainer || !progressBar || !progressText) return;
      
      // Show the progress elements
      progressContainer.style.display = 'flex';
      document.getElementById('progressDetails').style.display = 'block';
      
      // Update progress bar
      progressBar.style.width = `${percent}%`;
      progressBar.setAttribute('aria-valuenow', percent);
      
      // Update text
      progressText.textContent = text || `Processing ${percent}%`;
    }
    
    function hideProgress() {
      const progressContainer = document.getElementById('globalProgressContainer');
      const progressDetails = document.getElementById('progressDetails');
      
      if (progressContainer) progressContainer.style.display = 'none';
      if (progressDetails) progressDetails.style.display = 'none';
    }
    
    // Image error handling function
    function handleMatchImageError(imgElement, filename) {
      console.log(`Image error for ${filename}`);
      // Hide the image
      imgElement.style.display = 'none';
      
      const loadingDiv = imgElement.previousElementSibling;
      let cssClass = 'image-error';
      
      loadingDiv.innerHTML = `
        <i class='fas fa-exclamation-triangle fa-2x mb-2'></i>
        <span>Failed to load image</span>
        <button class="retry-image-btn" onclick="retryMatchImage(this, '${filename}')">
          <i class="fas fa-sync-alt"></i> Retry
        </button>
      `;
      loadingDiv.className = cssClass;
    }
    
    // Make retryMatchImage available globally
    window.retryMatchImage = function(btnElement, filename) {
      const errorDiv = btnElement.parentElement;
      const imgWrapper = errorDiv.parentElement;
      const imgElement = imgWrapper.querySelector('img');
      
      // Reset error div to loading state
      errorDiv.className = 'image-loading';
      errorDiv.innerHTML = `
        <div class="spinner-border text-primary mb-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span>Reloading image...</span>
      `;
      
      // Reset image and try loading again
      imgElement.style.display = '';
      const timestamp = new Date().getTime();
      imgElement.src = `/uploads/${filename}?retry=${timestamp}&r=${Math.random()}`;
    };
    
    function validateAllDisplayedImages() {
      document.querySelectorAll('img[data-filename]').forEach(img => {
        if (img.complete && !img.naturalWidth) {
          // Image loaded but has no content - try to fix
          const filename = img.getAttribute('data-filename');
          if (filename) {
            handleMatchImageError(img, filename);
          }
        }
      });
    }

    function displayMatchResult(matchData) {
      const resultDiv = document.getElementById("matchResult");
      resultDiv.innerHTML = ""; // Clear previous results
      
      const container = document.createElement('div');
      container.className = "comparison-container";
      
      // Create new item div
      const newDiv = document.createElement('div');
      newDiv.className = "item";
      newDiv.innerHTML = `
        <h3 class="item-header">New Item</h3>
        <div class="image-wrapper">
          <div class="image-loading">
            <div class="spinner-border text-primary mb-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading image...</span>
          </div>
          <img src="/uploads/${matchData.new_item.filename}?t=${new Date().getTime()}" 
               alt="New Item" 
               data-filename="${matchData.new_item.filename}"
               data-valid="true"
               onload="this.previousElementSibling.style.display='none';"
               onerror="handleMatchImageError(this, '${matchData.new_item.filename}')">
        </div>
        <ul class="property-list">
          <li><span class="property-name">Label:</span> <span class="property-value">${matchData.new_item.label}</span></li>
          <li><span class="property-name">Wearable:</span> <span class="property-value">${matchData.new_item.wearable}</span></li>
          <li><span class="property-name">Color:</span> <span class="property-value">
            <span class="color-sample" style="background-color:${matchData.new_item.color};"></span>
            ${matchData.new_item.color}
          </span></li>
          <li><span class="property-name">Pattern:</span> <span class="property-value">${matchData.new_item.pattern}</span></li>
        </ul>
      `;
      
      // Create match item div
      const matchDiv = document.createElement('div');
      matchDiv.className = "item";
      
      if (matchData.best_match) {
        matchDiv.innerHTML = `
          <h3 class="item-header">Best Match</h3>
          <div class="image-wrapper">
            <div class="image-loading">
              <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span>Loading image...</span>
            </div>
            <img src="/uploads/${matchData.best_match.filename}?t=${new Date().getTime()}" 
                 alt="Best Match" 
                 data-filename="${matchData.best_match.filename}"
                 onload="this.previousElementSibling.style.display='none';"
                 onerror="handleMatchImageError(this, '${matchData.best_match.filename}')">
          </div>
          <ul class="property-list">
            <li><span class="property-name">Label:</span> <span class="property-value">${matchData.best_match.data.label}</span></li>
            <li><span class="property-name">Wearable:</span> <span class="property-value">${matchData.best_match.data.wearable}</span></li>
            <li><span class="property-name">Color:</span> <span class="property-value">
              <span class="color-sample" style="background-color:${matchData.best_match.data.color};"></span>
              ${matchData.best_match.data.color}
            </span></li>
            <li><span class="property-name">Pattern:</span> <span class="property-value">${matchData.best_match.data.pattern}</span></li>
            <li><span class="property-name">Similarity Score:</span> <span class="property-value">${matchData.best_match.score.toFixed(2)}</span></li>
          </ul>
        `;
      } else {
        matchDiv.innerHTML = `<h3 class="item-header">No Matching Candidate Found</h3>`;
      }
      
      // Add items to container
      container.appendChild(newDiv);
      container.appendChild(matchDiv);
      resultDiv.appendChild(container);
      
      // Add reason if available
      if (matchData.best_match && matchData.reason) {
        const reasonContainer = document.createElement('div');
        reasonContainer.className = "reason-container fade-in";
        reasonContainer.innerHTML = `
          <h3>Why These Match Well</h3>
          <p class="single-reason">${matchData.reason}</p>
        `;
        resultDiv.appendChild(reasonContainer);
      }
    }
    
    // ==================== FORM HANDLERS ====================
    
    // Match form submission handler
    const matchForm = document.getElementById("matchForm");
    if (matchForm) {
      // Remove any existing handlers by cloning and replacing
      const newForm = matchForm.cloneNode(true);
      matchForm.parentNode.replaceChild(newForm, matchForm);
      
      // Add new handler
      document.getElementById("matchForm").addEventListener("submit", function(e) {
        e.preventDefault(); // Stop form from submitting normally
        console.log("Match form submitted");
        
        // Validate file input
        const fileInput = this.querySelector('input[type="file"]');
        if (!fileInput.files || fileInput.files.length === 0) {
          alert("Please select an image file first");
          return;
        }
        
        // Show progress
        showProgress(10, "Starting match analysis...");
        
        // Clear previous results
        document.getElementById("matchResult").innerHTML = "";
        
        // Create form data
        const formData = new FormData(this);
        
        // Send request
        console.log("Sending match request to server");
        fetch("/match_upload", {
          method: "POST",
          body: formData
        })
        .then(response => {
          console.log("Server response:", response.status);
          showProgress(70, "Processing server response...");
          
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Match data received:", data);
          showProgress(100, "Match complete!");
          
          if (data.error) {
            document.getElementById("matchResult").innerHTML = 
              `<div class="alert alert-danger">${data.error}</div>`;
          } else {
            displayMatchResult(data.matched);
          }
          
          // Hide progress bar after delay
          setTimeout(hideProgress, 1500);
        })
        .catch(error => {
          console.error("Match error:", error);
          showProgress(100, `Error: ${error.message}`);
          document.getElementById('globalProgressBar').classList.add('bg-danger');
          document.getElementById("matchResult").innerHTML = 
            `<div class="alert alert-danger">Error: ${error.message}</div>`;
            
          // Hide progress after delay
          setTimeout(hideProgress, 3000);
        });
      });
    }
    
    // Load matches button handler
    const loadMatchesBtn = document.getElementById("loadMatchesBtn");
    if (loadMatchesBtn) {
      const newBtn = loadMatchesBtn.cloneNode(true);
      loadMatchesBtn.parentNode.replaceChild(newBtn, loadMatchesBtn);
      
      document.getElementById("loadMatchesBtn").addEventListener("click", function() {
        console.log("Loading saved matches");
        const matchesList = document.getElementById("matchesList");
        
        matchesList.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading saved matches...</p>
          </div>
        `;
        
        fetch("/matches")
          .then(response => {
            if (!response.ok) {
              throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log("Matches loaded:", data);
            matchesList.innerHTML = "";
            
            if (!data.matches || data.matches.length === 0) {
              matchesList.innerHTML = `
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>No perfect matches stored.
                </div>
              `;
              return;
            }
            
            data.matches.forEach((match, index) => {
              const matchElement = document.createElement("div");
              matchElement.className = "match-record";
              matchElement.innerHTML = `
                <h4>Match #${index+1}</h4>
                <div class="comparison-container">
                  <div class="item">
                    <h5>New Item: ${match.new_item.label}</h5>
                    <img src="/uploads/${match.new_item.filename}?t=${new Date().getTime()}" 
                         alt="${match.new_item.label}"
                         style="max-height: 150px">
                  </div>
                  <div class="item">
                    <h5>Best Match: ${match.best_match.data.label}</h5>
                    <img src="/uploads/${match.best_match.filename}?t=${new Date().getTime()}" 
                         alt="${match.best_match.data.label}"
                         style="max-height: 150px">
                  </div>
                </div>
                <div class="reason-container">
                  <p>${match.reason || "These items match well together."}</p>
                </div>
                <button class="delete-btn" data-index="${index}">
                  <i class="fas fa-trash-alt me-1"></i> Delete
                </button>
              `;
              matchesList.appendChild(matchElement);
            });
            
            // Add delete button handlers
            document.querySelectorAll(".delete-btn").forEach(btn => {
              btn.addEventListener("click", function() {
                const index = this.getAttribute("data-index");
                deleteMatch(index);
              });
            });
          })
          .catch(error => {
            console.error("Error loading matches:", error);
            matchesList.innerHTML = 
              `<div class="alert alert-danger">Error loading matches: ${error.message}</div>`;
          });
      });
    }
    
    // Delete all matches button handler
    const deleteAllMatchesBtn = document.getElementById("deleteAllMatchesBtn");
    if (deleteAllMatchesBtn) {
      const newBtn = deleteAllMatchesBtn.cloneNode(true);
      deleteAllMatchesBtn.parentNode.replaceChild(newBtn, deleteAllMatchesBtn);
      
      document.getElementById("deleteAllMatchesBtn").addEventListener("click", function() {
        if (confirm("Are you sure you want to delete all matches?")) {
          console.log("Deleting all matches");
          
          fetch("/delete_all_matches", { 
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          })
          .then(response => response.json())
          .then(data => {
            alert(data.message || "All matches deleted");
            document.getElementById("matchesList").innerHTML = "";
          })
          .catch(error => {
            console.error("Error:", error);
            alert("Error deleting matches: " + error.message);
          });
        }
      });
    }
    
    // Delete single match function
    function deleteMatch(index) {
      console.log("Deleting match at index:", index);
      
      const formData = new FormData();
      formData.append("index", index);
      
      fetch("/delete_match", {
        method: "POST",
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          // Reload matches
          document.getElementById("loadMatchesBtn").click();
        } else {
          alert(data.error || "Error deleting match");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("Error: " + error.message);
      });
    }
    
    // Automatically validate images after page loads
    setTimeout(validateAllDisplayedImages, 1000);
  });

  // Make handleMatchImageError available globally
  window.handleMatchImageError = function(imgElement, filename) {
    console.log(`Image error for ${filename}`);
    // Hide the image
    imgElement.style.display = 'none';
    
    const loadingDiv = imgElement.previousElementSibling;
    let cssClass = 'image-error';
    
    loadingDiv.innerHTML = `
      <i class='fas fa-exclamation-triangle fa-2x mb-2'></i>
      <span>Failed to load image</span>
      <button class="retry-image-btn" onclick="retryMatchImage(this, '${filename}')">
        <i class="fas fa-sync-alt"></i> Retry
      </button>
    `;
    loadingDiv.className = cssClass;
  };
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>