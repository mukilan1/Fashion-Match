<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Capture Studio | Fashion Matching App</title>
  <!-- Bootstrap and Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <!-- MediaPipe libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-gradient: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
      --dark-gradient: linear-gradient(135deg, #334d50 0%, #cbcaa5 100%);
    }
    
    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0 0 60px 0;
      color: #333;
      min-height: 100vh;
    }
    
    .header {
      background: var(--primary-gradient);
      color: white;
      padding: 40px 0;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .header:before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/></svg>') repeat;
      opacity: 0.3;
    }
    
    .header h1 {
      font-weight: 700;
      margin-bottom: 10px;
      position: relative;
      z-index: 2;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      font-size: 1.2rem;
      position: relative;
      z-index: 2;
    }
    
    .page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Navigation Bar */
    .nav-bar {
      background-color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .nav-links {
      display: flex;
      gap: 5px;
    }
    
    .nav-bar a {
      text-decoration: none;
      color: #555;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 8px 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .nav-bar a:hover {
      background-color: #f8f9fa;
      color: #2575fc;
    }
    
    .nav-bar a.active {
      background-color: #e9f0ff;
      color: #2575fc;
    }
    
    /* Video Card */
    .video-card {
      background-color: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      position: relative;
    }
    
    .video-header {
      background: var(--accent-gradient);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .video-header h2 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .camera-status {
      background-color: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #dc3545;
    }
    
    .status-dot.active {
      background-color: #28a745;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.4);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(40, 167, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
      }
    }
    
    /* Video Container */
    .video-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
      background-color: #000;
      margin: 0 auto;
      overflow: hidden;
      max-width: 800px;
      transition: all 0.3s ease;
    }
    
    .input-video {
      position: absolute;
      display: none;
    }
    
    .output-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      object-fit: contain;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      transition: opacity 0.5s ease;
      opacity: 0;
      pointer-events: none;
      z-index: 10;
    }
    
    .loading-overlay.show {
      opacity: 1;
      pointer-events: all;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Controls */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 20px;
      background-color: #f8f9fa;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
      justify-content: center;
    }
    
    .btn-camera {
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      min-width: 150px;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .btn-camera::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }
    
    .btn-camera:hover::before {
      left: 100%;
    }
    
    .btn-start {
      background: var(--primary-gradient);
      color: white;
      border: none;
    }
    
    .btn-stop {
      background: var(--secondary-gradient);
      color: white;
      border: none;
      opacity: 0.8;
    }
    
    .btn-stop:not(:disabled):hover {
      opacity: 1;
      transform: translateY(-2px);
    }
    
    .btn-camera:not(:disabled):hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .btn-camera:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-message {
      background-color: #f1f1f1;
      border-radius: 8px;
      padding: 12px 15px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      width: 100%;
      color: #555;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .status-message.success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-message.error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .status-message.warning {
      background-color: #fff3cd;
      color: #856404;
    }
    
    /* Info Cards */
    .info-card {
      background-color: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
    }
    
    .info-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .info-header {
      background: var(--dark-gradient);
      color: white;
      padding: 15px 20px;
    }
    
    .info-header h2 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .info-body {
      padding: 20px;
    }
    
    /* Color Grid */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }
    
    .color-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 8px;
      background-color: #f8f9fa;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .color-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .color-box {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .color-box::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(0,0,0,0.1) 100%);
    }
    
    .color-name {
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    /* Features List */
    .features-list {
      padding-left: 5px;
      list-style-type: none;
    }
    
    .features-list li {
      position: relative;
      padding-left: 25px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
    }
    
    .features-list li i {
      position: absolute;
      left: 0;
      top: 5px;
      color: #3498db;
    }
    
    /* Error and Warning Messages */
    .error-message, .warning-message {
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .warning-message {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    /* Troubleshooting */
    .troubleshooting {
      background-color: #e2f3fd;
      padding: 20px;
      border-radius: 15px;
      margin-top: 25px;
      display: none;
      animation: fadeIn 0.5s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .troubleshooting h4 {
      color: #0c5460;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .troubleshooting ul {
      padding-left: 20px;
      margin-bottom: 0;
    }
    
    .troubleshooting li {
      margin-bottom: 10px;
      position: relative;
      padding-left: 5px;
    }
    
    /* FPS Counter */
    .fps-counter {
      background-color: rgba(0,0,0,0.7);
      color: white;
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 5;
      display: flex;
      align-items: center;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .fps-counter.show {
      opacity: 1;
    }
    
    /* Fullscreen Button */
    .fullscreen-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 18px;
      opacity: 0.7;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .fullscreen-btn:hover {
      opacity: 1;
    }
    
    /* Fullscreen Mode */
    .video-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      padding-bottom: 0;
      z-index: 10000;
      max-width: none;
      background-color: black;
    }
    
    .exit-fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10001;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .video-container.fullscreen .exit-fullscreen-btn {
      display: flex;
    }
    
    .exit-fullscreen-btn:hover {
      background-color: rgba(255, 0, 0, 0.7);
    }
    
    .fullscreen-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 8px 15px;
      border-radius: 4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 100;
    }
    
    .video-container.fullscreen .fullscreen-overlay {
      opacity: 1;
      animation: fade-out 3s forwards;
    }
    
    @keyframes fade-out {
      0%, 50% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .color-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      
      .controls {
        flex-direction: column;
        padding: 15px;
      }
      
      .btn-camera {
        width: 100%;
      }
      
      .nav-links {
        flex-wrap: wrap;
      }
      
      .video-container {
        padding-bottom: 75%; /* 4:3 for mobile */
      }
    }
    
    @media (max-width: 576px) {
      .header {
        padding: 30px 0;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      .video-header h2 {
        font-size: 1.2rem;
      }
      
      .info-header h2 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1><i class="fas fa-user-alt"></i> Motion Capture Studio</h1>
      <p class="lead">Visualize your body movement with enhanced 3D skeletal tracking</p>
    </div>
  </div>

  <div class="page-container">
    <!-- Navigation Bar -->
    <div class="nav-bar">
      <div class="nav-links">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a>
        <a href="{{ url_for('match_page') }}"><i class="fas fa-tshirt"></i> Clothing Match</a>
        <a href="{{ url_for('pose_rigging') }}" class="active"><i class="fas fa-user-alt"></i> Motion Studio</a>
      </div>
    </div>
    
    <!-- Main Video Card -->
    <div class="video-card">
      <div class="video-header">
        <h2><i class="fas fa-camera"></i> Live Pose Detection</h2>
        <div class="camera-status">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">Camera Off</span>
        </div>
      </div>
      
      <div class="video-container" id="video-container">
        <video class="input-video"></video>
        <canvas class="output-canvas"></canvas>
        <div class="loading-overlay" id="loading-overlay">
          <div class="spinner"></div>
          <p>Initializing pose detection...</p>
        </div>
        <div class="fps-counter" id="fps-counter">
          <i class="fas fa-tachometer-alt"></i>
          <span id="fps-text">0 FPS</span>
        </div>
        <button class="fullscreen-btn" id="fullscreen-btn">
          <i class="fas fa-expand"></i>
        </button>
        <button class="exit-fullscreen-btn" id="exit-fullscreen-btn">
          <i class="fas fa-times"></i>
        </button>
        <div class="fullscreen-overlay" id="fullscreen-overlay">
          Press ESC or click X to exit fullscreen
        </div>
      </div>
      
      <div class="controls">
        <button id="start-button" class="btn-camera btn-start">
          <i class="fas fa-play"></i> Start Camera
        </button>
        <button id="stop-button" class="btn-camera btn-stop" disabled>
          <i class="fas fa-stop"></i> Stop Camera
        </button>
        <div class="status-message" id="status-message">
          <i class="fas fa-info-circle"></i>
          <span>Ready to start pose detection</span>
        </div>
      </div>
    </div>
    
    <div class="row g-4">
      <div class="col-md-6">
        <div class="info-card">
          <div class="info-header">
            <h2><i class="fas fa-palette"></i> Color Legend</h2>
          </div>
          <div class="info-body">
            <div class="color-grid">
              <div class="color-item">
                <span class="color-box" style="background: #3498db;"></span>
                <span class="color-name">Right Arm</span>
              </div>
              <div class="color-item">
                <span class="color-box" style="background: #2ecc71;"></span>
                <span class="color-name">Left Arm</span>
              </div>
              <div class="color-item">
                <span class="color-box" style="background: #e74c3c;"></span>
                <span class="color-name">Right Leg</span>
              </div>
              <div class="color-item">
                <span class="color-box" style="background: #9b59b6;"></span>
                <span class="color-name">Left Leg</span>
              </div>
              <div class="color-item">
                <span class="color-box" style="background: #1abc9c;"></span>
                <span class="color-name">Torso</span>
              </div>
              <div class="color-item">
                <span class="color-box" style="background: #f1c40f;"></span>
                <span class="color-name">Face</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="info-card">
          <div class="info-header">
            <h2><i class="fas fa-tshirt"></i> Fashion Application</h2>
          </div>
          <div class="info-body">
            <p>This motion capture technology enhances your fashion experience by:</p>
            <ul class="features-list">
              <li><i class="fas fa-ruler"></i> Providing accurate body measurements for better clothing fit</li>
              <li><i class="fas fa-tshirt"></i> Visualizing how clothing moves with your body</li>
              <li><i class="fas fa-user-check"></i> Understanding your posture and body proportions</li>
              <li><i class="fas fa-walking"></i> Analyzing your movement patterns for style recommendations</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Error and warning messages -->
    <div id="error-message" class="error-message">
      <i class="fas fa-exclamation-circle me-2"></i>
      <span id="error-text">Error message will appear here</span>
    </div>
    
    <div id="warning-message" class="warning-message">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <span id="warning-text">Warning message will appear here</span>
    </div>
    
    <div class="troubleshooting" id="troubleshooting">
      <h4><i class="fas fa-tools"></i> Troubleshooting Tips</h4>
      <ul>
        <li>Make sure your camera is properly connected and not being used by another application</li>
        <li>Allow camera permissions when prompted by your browser</li>
        <li>Try using a different browser (Chrome or Firefox recommended)</li>
        <li>Make sure you're in a well-lit environment</li>
        <li>Ensure you're visible in the frame from head to mid-thigh for best results</li>
        <li>If the detection is slow, try reducing background clutter</li>
      </ul>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/pose_rigging.js') }}"></script>
  <script src="{{ url_for('static', filename='js/fullscreen.js') }}"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Reference to elements
      const videoElement = document.querySelector('.input-video');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      const warningMessage = document.getElementById('warning-message');
      const warningText = document.getElementById('warning-text');
      const troubleshooting = document.getElementById('troubleshooting');
      const loadingOverlay = document.getElementById('loading-overlay');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const fpsCounter = document.getElementById('fps-counter');
      
      // Show loading overlay while initializing
      loadingOverlay.classList.add('show');
      
      // Create a global object to manage UI updates from pose_rigging.js
      window.PoseUI = {
        setStatus: function(status, type = 'info') {
          const statusMessage = document.getElementById('status-message');
          const messageSpan = statusMessage.querySelector('span');
          const icon = statusMessage.querySelector('i');
          
          // Update message
          messageSpan.textContent = status;
          
          // Reset classes
          statusMessage.className = 'status-message';
          icon.className = 'fas';
          
          // Apply styling based on status type
          switch (type) {
            case 'success':
              statusMessage.classList.add('success');
              icon.classList.add('fa-check-circle');
              statusDot.classList.add('active');
              statusText.textContent = 'Camera Active';
              break;
            case 'error':
              statusMessage.classList.add('error');
              icon.classList.add('fa-exclamation-circle');
              statusDot.classList.remove('active');
              statusText.textContent = 'Error';
              break;
            case 'warning':
              statusMessage.classList.add('warning');
              icon.classList.add('fa-exclamation-triangle');
              statusDot.classList.remove('active');
              statusText.textContent = 'Warning';
              break;
            default:
              icon.classList.add('fa-info-circle');
              statusDot.classList.remove('active');
              statusText.textContent = 'Camera Off';
          }
        },
        updateFPS: function(fps) {
          const fpsText = document.getElementById('fps-text');
          fpsText.textContent = `${fps.toFixed(1)} FPS`;
          if (!fpsCounter.classList.contains('show')) {
            fpsCounter.classList.add('show');
          }
        },
        hideLoading: function() {
          loadingOverlay.classList.remove('show');
        }
      };
      
      // Add event listener for camera errors
      videoElement.addEventListener('error', function(e) {
        console.error('Video element error:', e);
        errorMessage.style.display = 'block';
        errorText.textContent = 'Camera access error: ' + (e.message || 'Could not access camera');
        loadingOverlay.classList.remove('show');
        troubleshooting.style.display = 'block';
      });
      
      // Check browser compatibility
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        console.log('getUserMedia supported');
      } else {
        warningMessage.style.display = 'block';
        warningText.textContent = 'Your browser may not support camera access. Please use Chrome or Firefox.';
        troubleshooting.style.display = 'block';
        loadingOverlay.classList.remove('show');
      }
      
      // Hide loading overlay if it takes too long (fallback)
      setTimeout(() => {
        loadingOverlay.classList.remove('show');
      }, 5000);
    });
  </script>
  
  <!-- Dress Collection Section -->
  <div class="page-container mt-5">
    <div class="video-card">
      <div class="video-header" style="background: var(--secondary-gradient);">
        <h2><i class="fas fa-tshirt"></i> Your Clothing Collection</h2>
        <div class="camera-status">
          <span class="status-dot active"></span>
          <span>Available Items</span>
        </div>
      </div>
      
      <div class="info-body p-4">
        <div class="d-flex align-items-center justify-content-between mb-4">
          <p class="mb-0">These are all the items from your wardrobe that you can visualize with motion capture:</p>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="showAllItems" checked>
            <label class="form-check-label" for="showAllItems">Show All Items</label>
          </div>
        </div>
        
        <!-- Debug info to help identify the issue (can be removed later) -->
        <div id="debug-info" style="display: none; margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px;">
          <p>Total images: {{ images|length if images else 0 }}</p>
          <p>Image types:</p>
          <ul>
            {% for image in images %}
              <li>{{ image.label }} - Wearable: "{{ image.wearable }}"</li>
            {% endfor %}
          </ul>
          <button class="btn btn-sm btn-secondary" onclick="document.getElementById('debug-info').style.display='none'">Hide Debug Info</button>
        </div>
        <button class="btn btn-sm btn-outline-secondary mb-3" onclick="document.getElementById('debug-info').style.display='block'">Show Debug Info</button>
        
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4" id="dressCollection">
          {% set dress_count = 0 %}
          
          <!-- First try to show dress/skirt items -->
          {% for image in images %}
            {% if image.wearable|lower == 'dress' or
                  image.is_dress_item or
                  'gown' in image.label|lower or
                  'sarong' in image.label|lower or 
                  'dress' in image.label|lower or
                  'skirt' in image.label|lower or
                  image.costume|lower == 'party' %}
              {% set dress_count = dress_count + 1 %}
              <div class="col" id="dress-item-{{ image.filename }}">
                <div class="info-card mb-0" style="overflow: visible;">
                  <div style="height: 200px; position: relative; border-radius: 15px 15px 0 0; overflow: hidden;">
                    <!-- Loading placeholder -->
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; color: #6c757d; z-index: 1;">
                      <i class="fas fa-spinner fa-spin"></i>
                      <p>Loading item...</p>
                    </div>
                    
                    <!-- Error container -->
                    <div class="image-error-container" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; background-color: #f8f9fa; color: #dc3545; z-index: 2;" id="pose-error-{{ image.filename }}">
                      <i class="fas fa-exclamation-circle text-danger"></i>
                      <p>Failed to load image</p>
                      <button class="retry-button" onclick="retryLoadDressImage(this, '{{ image.filename }}')">
                        <i class="fas fa-sync-alt"></i> Retry
                      </button>
                    </div>
                    
                    {% if image.is_valid %}
                    <img src="{{ url_for('uploaded_file', filename=image.filename) }}?t={{ range(1, 9999) | random }}" 
                         alt="{{ image.label }}" 
                         class="pose-lazy-load"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.5s; z-index: 0;"
                         data-valid="true"
                         id="pose-img-{{ image.filename }}"
                         onload="handlePoseDressImageLoad(this)"
                         onerror="handlePoseDressImageError(this, '{{ image.filename }}')">
                    {% else %}
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f0f0f0; color: #6c757d; z-index: 1;">
                      <i class="fas fa-tshirt" style="font-size: 2.5rem; margin-bottom: 10px;"></i>
                      <p>{{ image.label }}</p>
                      <small>(Image unavailable)</small>
                    </div>
                    {% endif %}
                  </div>
                  
                  <div class="info-body" style="padding: 15px;">
                    <h5 class="mb-3">{{ image.label }}</h5>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      <span class="badge bg-primary">Wearable Item</span>
                      <span class="badge bg-secondary">{{ image.sex }}</span>
                      {% if image.costume != 'Unknown' %}
                        <span class="badge bg-info">{{ image.costume }}</span>
                      {% endif %}
                      {% if image.pattern != 'Unknown' and image.pattern != 'plain' %}
                        <span class="badge bg-success">{{ image.pattern }}</span>
                      {% endif %}
                    </div>
                    
                    <div class="mt-3 d-flex align-items-center">
                      <span style="display: inline-block; width: 25px; height: 25px; border-radius: 4px; background-color: {{ image.color }}; margin-right: 10px; border: 1px solid #ddd;"></span>
                      <span style="font-weight: 500;">{{ image.color }}</span>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
          
          <!-- If no dress items were found, show all clothing items -->
          {% if dress_count == 0 %}
            {% for image in images %}
              <div class="col" id="clothing-item-{{ image.filename }}">
                <div class="info-card mb-0" style="overflow: visible;">
                  <div style="height: 200px; position: relative; border-radius: 15px 15px 0 0; overflow: hidden;">
                    <!-- Loading placeholder -->
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; color: #6c757d; z-index: 1;">
                      <i class="fas fa-spinner fa-spin"></i>
                      <p>Loading item...</p>
                    </div>
                    
                    <!-- Error container -->
                    <div class="image-error-container" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; background-color: #f8f9fa; color: #dc3545; z-index: 2;" id="pose-error-{{ image.filename }}">
                      <i class="fas fa-exclamation-circle text-danger"></i>
                      <p>Failed to load image</p>
                      <button class="retry-button" onclick="retryLoadDressImage(this, '{{ image.filename }}')">
                        <i class="fas fa-sync-alt"></i> Retry
                      </button>
                    </div>
                    
                    {% if image.is_valid %}
                    <img src="{{ url_for('uploaded_file', filename=image.filename) }}?t={{ range(1, 9999) | random }}" 
                         alt="{{ image.label }}" 
                         class="pose-lazy-load"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.5s; z-index: 0;"
                         data-valid="true"
                         id="pose-img-{{ image.filename }}"
                         onload="handlePoseDressImageLoad(this)"
                         onerror="handlePoseDressImageError(this, '{{ image.filename }}')">
                    {% else %}
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f0f0f0; color: #6c757d; z-index: 1;">
                      <i class="fas fa-tshirt" style="font-size: 2.5rem; margin-bottom: 10px;"></i>
                      <p>{{ image.label }}</p>
                      <small>(Image unavailable)</small>
                    </div>
                    {% endif %}
                  </div>
                  
                  <div class="info-body" style="padding: 15px;">
                    <h5 class="mb-3">{{ image.label }}</h5>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      <span class="badge bg-primary">{{ image.wearable }}</span>
                      <span class="badge bg-secondary">{{ image.sex }}</span>
                      {% if image.costume != 'Unknown' %}
                        <span class="badge bg-info">{{ image.costume }}</span>
                      {% endif %}
                      {% if image.pattern != 'Unknown' and image.pattern != 'plain' %}
                        <span class="badge bg-success">{{ image.pattern }}</span>
                      {% endif %}
                    </div>
                    
                    <div class="mt-3 d-flex align-items-center">
                      <span style="display: inline-block; width: 25px; height: 25px; border-radius: 4px; background-color: {{ image.color }}; margin-right: 10px; border: 1px solid #ddd;"></span>
                      <span style="font-weight: 500;">{{ image.color }}</span>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endif %}
          
          <!-- No items found message -->
          {% if images|length == 0 %}
            <div class="col-12">
              <div style="background-color: #e2f3fd; padding: 20px; border-radius: 15px; margin-top: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-info-circle" style="color: #0c5460; font-size: 24px;"></i>
                  <div>
                    <h4 style="color: #0c5460; margin: 0; font-weight: 600;">No Items Found</h4>
                    <p style="margin: 5px 0 0 0;">You haven't uploaded any items to your collection yet.</p>
                  </div>
                </div>
                <div class="mt-3">
                  <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i> Upload Items
                  </a>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Image handling functions for dress collection
    function handlePoseDressImageLoad(imgElement) {
      // Show the image and hide placeholder
      imgElement.style.opacity = '1';
      const placeholder = imgElement.previousElementSibling?.previousElementSibling;
      if (placeholder) {
        placeholder.style.display = 'none';
      }
    }
    
    function handlePoseDressImageError(imgElement, filename) {
      // First attempt with cache busting
      if (!imgElement.dataset.retried) {
        imgElement.dataset.retried = '1';
        const timestamp = new Date().getTime();
        imgElement.src = `/uploads/${filename}?nocache=${timestamp}`;
        return;
      }
      
      // After retry, show error
      const errorContainer = document.getElementById('pose-error-' + filename);
      if (errorContainer) {
        errorContainer.style.display = 'flex';
      }
      
      // Hide placeholder
      const placeholder = imgElement.previousElementSibling?.previousElementSibling;
      if (placeholder) {
        placeholder.style.display = 'none';
      }
    }
    
    function retryLoadDressImage(btnElement, filename) {
      const imgElement = document.getElementById('pose-img-' + filename);
      if (imgElement) {
        // Reset error container visibility
        const errorContainer = btnElement.parentNode;
        errorContainer.style.display = 'none';
        
        // Show loading placeholder again
        const placeholder = errorContainer.previousElementSibling;
        if (placeholder) {
          placeholder.style.display = 'flex';
        }
        
        // Reset image element
        imgElement.style.opacity = '0';
        imgElement.dataset.retried = '';
        
        // Force browser to make a completely fresh request
        const timestamp = new Date().getTime();
        const randomParam = Math.floor(Math.random() * 1000000);
        imgElement.src = `/uploads/${filename}?retry=${timestamp}&r=${randomParam}`;
      }
    }
    
    // Initialize image loading and toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing dress collection display');
      
      // Add toggle functionality for showing all items vs just dress items
      const showAllItemsToggle = document.getElementById('showAllItems');
      if (showAllItemsToggle) {
        showAllItemsToggle.addEventListener('change', function() {
          const dressItems = document.querySelectorAll('[id^="dress-item-"]');
          const clothingItems = document.querySelectorAll('[id^="clothing-item-"]');
          
          if (this.checked) {
            // Show all items
            dressItems.forEach(item => item.style.display = 'block');
            clothingItems.forEach(item => item.style.display = 'block');
          } else {
            // Show only dress items
            dressItems.forEach(item => item.style.display = 'block');
            clothingItems.forEach(item => item.style.display = 'none');
          }
        });
      }
    });
  </script>
</body>
</html>