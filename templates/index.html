<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Images</title>
</head>
<body>
    <h1>Upload Images</h1>
    <!-- New: Match-making button -->
    <a href="/match"><button type="button">Go to Match Making</button></a>
    <h1>Upload Multiple Images</h1>
    <form id="uploadForm">
        <input type="file" name="images" id="images" multiple accept="image/*">
        <button type="submit">Upload Multiple</button>
    </form>
    <div id="preview"></div>
    <div id="result"></div>
    <!-- Display history of stored images with all extracted features -->
    <h2>Uploaded Images History</h2>
    <button onclick="deleteAllImages()">Delete All</button>
    <div id="history">
        {% for image in images %}
          <div id="img-{{ image.filename }}">
            <img src="{{ url_for('uploaded_file', filename=image.filename) }}" style="max-width:150px; margin:5px;">
            <div>Label: {{ image.label }}</div>
            <div>Wearable: {{ image.wearable }}</div>
            <div>Costume: {{ image.costume }}</div>
            <div>Sex: {{ image.sex }}</div>
            <div>
                Color: <span style="display:inline-block;width:20px;height:20px;background-color:{{ image.color }};border:1px solid #000;"></span>
                ({{ image.color }})
            </div>
            <div>Pattern: {{ image.pattern }}</div>
            {# Removed Hand Style display #}
            <button onclick="deleteImage('{{ image.filename }}')">Delete</button>
          </div>
        {% endfor %}
    </div>
    <script>
    // Preview selected images
    document.getElementById('images').addEventListener('change', function() {
        const preview = document.getElementById('preview');
        preview.innerHTML = ''; // Clear any existing content
        Array.from(this.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '150px';
                img.style.margin = '5px';
                preview.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    });
    // Asynchronous file upload to make it faster
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const files = document.getElementById('images').files;
        const formData = new FormData();
        for(let i = 0; i < files.length; i++) {
            formData.append('images', files[i]);
        }
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData,
        });
        const result = await response.json();
        document.getElementById('result').innerText = JSON.stringify(result);
    });

    function deleteImage(imageName) {
        fetch('/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'filename=' + encodeURIComponent(imageName)
        })
        .then(res => res.json())
        .then(data => {
            if(data.deleted) {
                alert("Deleted image with label: " + data.label + ", wearable type: " + data.wearable);
                document.getElementById('img-' + imageName).remove();
            } else {
                alert(data.error);
            }
        });
    }

    async function deleteAllImages() {
        if(confirm("Are you sure you want to delete all files?")) {
            const response = await fetch('/delete_all', {
                method: 'POST'
            });
            const result = await response.json();
            if(result.deleted_all) {
                alert(result.message);
                document.getElementById('history').innerHTML = "";
            } else {
                alert("Error deleting files");
            }
        }
    }

    // New: Automatic Combo Generation handler with reason display
    document.getElementById("autoMatchBtn").addEventListener("click", async function() {
         const response = await fetch("/auto_match", { method: "GET" });
         const res = await response.json();
         const container = document.getElementById("autoMatchesResult");
         container.innerHTML = "";
         if(res.auto_matches.length === 0) {
             container.innerText = "No automatic matches found.";
             return;
         }
         res.auto_matches.forEach(match => {
             const record = document.createElement("div");
             record.className = "match-record";
             record.innerHTML = `
                 <h4>Top: ${match.top.data.label} (${match.top.data.wearable})</h4>
                 <h4>Bottom: ${match.bottom.data.label} (${match.bottom.data.wearable})</h4>
                 <p>Similarity Score: ${match.score.toFixed(2)}</p>
                 <p>Reason: ${match.reason}</p>
                 <img src="/uploads/${match.top.filename}" style="max-width:100px; margin-right:10px;">
                 <img src="/uploads/${match.bottom.filename}" style="max-width:100px;">
             `;
             container.appendChild(record);
         });
    });
    </script>
</body>
</html>
